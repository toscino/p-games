// --- PARSER ---
        function parseHtmlForTimes(htmlText) {
            // New Robust Parser: Scans whole text for "To [Destination] ... [Time]" pattern
            // \s* = allows any amount of whitespace
            // .*? = allows junk characters in between (like " ... ")
            const timeRegex = /To\s+(?:Edgebrook|Fox\s+Lake|Healy|Lake\s+Forest).*?(\d{1,2}:\d{2}\s*[AP]M)/gi;
            
            // Create a DOM parser to strip HTML tags safely first
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const cleanText = doc.body.innerText.replace(/\s+/g, ' '); // Flatten all whitespace to single spaces
            
            const foundTimes = [];
            let match;
            
            // Execute regex on the cleaned single-line text
            while ((match = timeRegex.exec(cleanText)) !== null) {
                if (match[1]) {
                    foundTimes.push(convert12to24(match[1]));
                }
            }
            
            return { times: foundTimes, hasNoService: cleanText.includes("No service") };
        }

        // --- LIVE DATA FETCHING ---
        async function fetchLiveTimes() {
            lastFetchTime = Date.now();
            const targetUrl = 'https://metratracker.com/bustime/wireless/html/eta.jsp?route=MD-N&originstop=Chicago+Union+Station&destinationstop=Edgebrook&id=CUS&destinationid=EDGEBROOK&direction=OUTBOUND&showAllBusses=off&t=' + Date.now();
            
            // List of proxies to try in order
            const proxies = [
                { name: 'CorsProxy', url: 'https://corsproxy.io/?' + encodeURIComponent(targetUrl), type: 'text' },
                { name: 'AllOrigins', url: 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl), type: 'json' },
                { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' + targetUrl, type: 'text' }
            ];

            let success = false;
            const debugEl = document.getElementById('footer-note');

            for (const proxy of proxies) {
                try {
                    debugEl.innerHTML = `Trying ${proxy.name}...`;
                    console.log(`Attempting ${proxy.name}...`);
                    
                    const response = await fetch(proxy.url);
                    if (!response.ok) throw new Error('Network error');
                    
                    let text = "";
                    if (proxy.type === 'json') {
                        const data = await response.json();
                        text = data.contents;
                    } else {
                        text = await response.text();
                    }

                    const result = parseHtmlForTimes(text);
                    
                    if (result.times.length > 0 || result.hasNoService) {
                        liveData = result.times;
                        isUsingLive = true;
                        debugEl.innerHTML = `<span class="text-green-500">● Connected via ${proxy.name}</span>`;
                        success = true;
                        break; // Stop trying other proxies
                    }
                } catch (error) {
                    console.warn(`${proxy.name} failed:`, error);
                }
            }

            if (!success) {
                console.error("All proxies failed.");
                debugEl.innerHTML = `<span class="text-yellow-600/70">⚠ Connection failed. Using Schedule.</span>`;
                // Keep isUsingLive as previous state or false
            }
        }

        // --- MAIN APP LOOP ---
        async function updateApp() {
            const now = new Date();
            
            // Check fetch (Every 60s)
            if (Date.now() - lastFetchTime > REFRESH_INTERVAL_MS) {
                document.getElementById('data-source-badge').innerHTML = `<div class="loader"></div>`;
                await fetchLiveTimes();
            }

            // --- UI STATE MANAGEMENT ---
            let timesList = [];
            let sourceLabel = "";
            let scheduleType = "";
            let isTomorrow = false;
            
            const heroIndicator = document.getElementById('hero-status-indicator');
            const liveViewPill = document.getElementById('live-view-pill');
            
            // If fetchLiveTimes is working, footer note is already set by that function
            // Only overwrite it here if we are in pure offline mode from start
            const footerNoteEl = document.getElementById('footer-note');

            if (isUsingLive && liveData) {
                // --- LIVE MODE ---
                timesList = liveData;
                sourceLabel = `<span class="text-green-400 font-bold"><i class="fa-solid fa-wifi"></i> Live</span>`;
                scheduleType = "Live Tracker";
                
                // Show Green Pill in Hero
                heroIndicator.innerHTML = `
                 <div class="flex items-center gap-2 bg-green-900/40 border border-green-500/30 px-3 py-1 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.2)]">
                    <div class="live-dot"></div>
                    <span class="text-[10px] font-bold text-green-400 uppercase tracking-widest">Live Tracker</span>
                 </div>`;
                 
                 // STOP pulsing external button
                 liveViewPill.classList.remove('pulse-ring');
                 liveViewPill.classList.remove('bg-blue-600/20');
                 liveViewPill.classList.add('bg-gray-700/50'); 

                if (timesList.length === 0) {
                     const tomorrow = new Date(now);
                     tomorrow.setDate(tomorrow.getDate() + 1);
                     const nextDaySchedule = getScheduleForDate(tomorrow);
                     timesList = nextDaySchedule.times;
                     sourceLabel = `<span class="text-yellow-500"><i class="fa-solid fa-calendar"></i> Sched (Tmrw)</span>`;
                     isTomorrow = true;
                     heroIndicator.innerHTML = `
                         <div class="flex items-center gap-2 bg-yellow-900/30 border border-yellow-600/30 px-3 py-1 rounded-full">
                            <i class="fa-solid fa-bed text-[10px] text-yellow-500"></i>
                            <span class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest">No Active Trains</span>
                         </div>`;
                }
            } else {
                // --- SCHEDULE MODE ---
                const currentSchedule = getScheduleForDate(now);
                timesList = currentSchedule.times;
                sourceLabel = `<span class="text-gray-400"><i class="fa-solid fa-calendar"></i> Sched</span>`;
                scheduleType = currentSchedule.type;
                
                // Show Gray Pill in Hero
                heroIndicator.innerHTML = `
                 <div class="flex items-center gap-2 bg-gray-700/50 border border-gray-600 px-3 py-1 rounded-full">
                    <i class="fa-solid fa-calendar text-[10px] text-gray-400"></i>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Using Schedule</span>
                 </div>`;
                 
                // START pulsing external button
                liveViewPill.classList.add('pulse-ring');
                liveViewPill.classList.add('bg-blue-600/20');
                liveViewPill.classList.remove('bg-gray-700/50');
                
                // Only set this if we haven't tried fetching yet or failed completely
                if (footerNoteEl.innerText === "Waiting for connection...") {
                     footerNoteEl.innerText = "Connecting...";
                }
            }

            // Standardize current time
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeVal = currentHours * 60 + currentMinutes;

            let nextTrain = null;
            let laterTrains = [];
            let scheduleDisplayDate = new Date(now);

            // Filter logic
            if (isTomorrow) {
                scheduleDisplayDate.setDate(scheduleDisplayDate.getDate() + 1);
                nextTrain = timesList[0];
                laterTrains = timesList.slice(1);
            } else {
                for (let time of timesList) {
                    const [h, m] = time.split(':').map(Number);
                    let trainTimeVal = h * 60 + m;
                    if (h >= 24) trainTimeVal = (h - 24) * 60 + m + (24 * 60);

                    if (isUsingLive) {
                         if (!nextTrain) nextTrain = time;
                         else laterTrains.push(time);
                    } else {
                        if (trainTimeVal > currentTimeVal || h >= 24) {
                            if (!nextTrain) nextTrain = time;
                            else laterTrains.push(time);
                        }
                    }
                }

                if (!nextTrain) {
                    isTomorrow = true;
                    scheduleDisplayDate.setDate(scheduleDisplayDate.getDate() + 1);
                    const tomorrowSchedule = getScheduleForDate(scheduleDisplayDate);
                    nextTrain = tomorrowSchedule.times[0];
                    laterTrains = tomorrowSchedule.times.slice(1);
                    
                    if (!isUsingLive) {
                        scheduleType = tomorrowSchedule.type;
                    }
                }
            }

            // Render
            const minutesUntil = getMinutesUntil(nextTrain, scheduleDisplayDate);
            
            // DOM Elements
            const timeRemainingEl = document.getElementById('time-remaining');
            const departureTimeEl = document.getElementById('departure-time');
            const listEl = document.getElementById('schedule-list');
            const statusMsgEl = document.getElementById('status-message');
            const scheduleTypeEl = document.getElementById('schedule-type');
            const badgeEl = document.getElementById('data-source-badge');

            // Update Badge
            badgeEl.innerHTML = sourceLabel;

            // Update Main Display
            if (minutesUntil <= 0 && !isTomorrow) {
                 timeRemainingEl.innerText = "Now";
                 timeRemainingEl.className = "text-5xl font-extrabold tracking-tight text-green-400 drop-shadow-lg";
                 statusMsgEl.innerText = "Train is departing";
            } else {
                if (minutesUntil > 99) {
                    const hours = Math.floor(minutesUntil / 60);
                    const mins = minutesUntil % 60;
                    timeRemainingEl.innerHTML = `${hours}<span class="text-2xl">h</span> ${mins}<span class="text-2xl">m</span>`;
                    timeRemainingEl.className = "text-5xl font-extrabold tracking-tight text-white drop-shadow-lg";
                } else {
                    timeRemainingEl.innerText = minutesUntil;
                    timeRemainingEl.className = "text-6xl font-extrabold tracking-tight text-white drop-shadow-lg";
                }
                statusMsgEl.innerText = isTomorrow ? "First train tomorrow in" : "Departure in";
            }

            departureTimeEl.innerText = formatTime12h(nextTrain);
            scheduleTypeEl.innerText = `${scheduleType} • ${isTomorrow ? 'Tomorrow' : 'Today'}`;

            // Update List
            listEl.innerHTML = '';
            if (laterTrains.length === 0) {
                listEl.innerHTML = `<div class="text-gray-500 text-center py-4 text-sm">No more trains today</div>`;
            } else {
                laterTrains.forEach(time => {
                    if (time.startsWith("24:")) return; 
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-gray-600 transition-colors";
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400">
                                <i class="fa-solid fa-train"></i>
                            </div>
                            <span class="text-lg font-semibold text-gray-200">${formatTime12h(time)}</span>
                        </div>
                        <span class="text-sm text-gray-500 font-medium">MD-N</span>
                    `;
                    listEl.appendChild(el);
                });
            }
        }

        // Initialize
        updateApp();
        // UI ticks every 10s, but fetch only happens every 60s
        setInterval(updateApp, 10000); 
    </script>
</body>
</html>
<!-- ... existing code ... -->
        <!-- Footer -->
        <div class="p-4 bg-gray-950 text-center border-t border-gray-800">
            <p class="text-xs text-gray-600" id="schedule-type">Initializing...</p>
            <p class="text-[10px] text-gray-700 mt-1" id="footer-note">Waiting for connection...</p>
            <p class="text-[9px] text-gray-800 mt-2 font-mono">v