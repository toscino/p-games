<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Train: Union Station to Edgebrook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .train-card { transition: transform 0.2s; }
        .train-card:active { transform: scale(0.98); }
        
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Status Dot Pulse */
        .live-dot {
            height: 8px;
            width: 8px;
            background-color: #4ade80;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        
        /* Loading spinner */
        .loader {
            border: 2px solid #374151;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-gray-800 rounded-3xl shadow-2xl overflow-hidden border border-gray-700 relative">
        
        <!-- Header -->
        <div class="bg-gray-800 p-6 border-b border-gray-700 flex justify-between items-start">
            <div>
                <h1 class="text-xs font-bold tracking-widest text-gray-400 uppercase mb-1">Metra MD-N</h1>
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    Union St. <i class="fa-solid fa-arrow-right text-sm text-gray-500"></i> Edgebrook
                </h2>
            </div>
            <!-- Live Tracker Link -->
            <a href="https://metratracker.com/bustime/wireless/html/eta.jsp?route=MD-N&originstop=Chicago+Union+Station&destinationstop=Edgebrook&id=CUS&destinationid=EDGEBROOK&direction=OUTBOUND&showAllBusses=off" target="_blank" 
               id="live-view-btn"
               class="group flex flex-col items-end gap-1 text-right">
                <div id="live-view-pill" class="flex items-center gap-2 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 px-3 py-1.5 rounded-full transition-all">
                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                    <span class="text-xs font-bold text-blue-400 group-hover:text-blue-300">Verify Live</span>
                    <i class="fa-solid fa-external-link-alt text-[10px] text-blue-500"></i>
                </div>
            </a>
        </div>

        <!-- Hero Section: Next Train -->
        <div class="p-8 text-center bg-gradient-to-b from-gray-800 to-gray-900 relative">
            
            <!-- Explicit Status Indicator (Always Visible) -->
            <div id="hero-status-indicator" class="absolute top-4 left-0 right-0 flex justify-center transition-all duration-500">
                 <!-- Default State: Loading -->
                 <div class="flex items-center gap-2 bg-gray-700/50 border border-gray-600 px-3 py-1 rounded-full">
                    <div class="loader"></div>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Connecting...</span>
                 </div>
            </div>

            <p id="status-message" class="text-gray-400 text-sm mb-2 font-medium mt-6">Loading...</p>
            
            <div id="countdown-container" class="mb-6 relative z-10">
                <span id="time-remaining" class="text-6xl font-extrabold tracking-tight text-white drop-shadow-lg">--</span>
                <span class="text-xl text-gray-500 font-normal">min</span>
            </div>

            <div class="inline-flex items-center justify-center gap-3 bg-gray-700/50 px-6 py-3 rounded-2xl border border-gray-600/50 backdrop-blur-sm">
                <i class="fa-regular fa-clock text-blue-400"></i>
                <span id="departure-time" class="text-2xl font-bold text-blue-100 tracking-wide">--:--</span>
            </div>
        </div>

        <!-- Schedule List -->
        <div class="bg-gray-900 px-6 py-6">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 flex justify-between items-center">
                <span>Upcoming Trains</span>
                <span id="data-source-badge" class="text-[10px] bg-gray-800 px-2 py-0.5 rounded text-gray-500 border border-gray-700 flex items-center gap-1">
                    <div class="loader"></div> Checking...
                </span>
            </h3>
            <div id="schedule-list" class="space-y-3">
                <!-- Trains injected here -->
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-12 bg-gray-700 rounded-xl"></div>
                        <div class="h-12 bg-gray-700 rounded-xl"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 bg-gray-950 text-center border-t border-gray-800">
            <p class="text-xs text-gray-600" id="schedule-type">Initializing...</p>
            <p class="text-[10px] text-gray-700 mt-1" id="footer-note">Waiting for connection...</p>
            <p class="text-[9px] text-gray-800 mt-2 font-mono">v1.1</p>
        </div>
    </div>

    <script>
        // --- BACKUP SCHEDULE (24h format) ---
        const weekdaySchedule = [
            "00:32", "06:25", "06:48", "07:05", "07:32", "08:32", "09:32", "10:32", "11:32", 
            "12:32", "13:32", "14:23", "15:30", "15:55", "16:00", "16:23", "16:28", 
            "16:53", "17:13", "17:18", "17:43", "17:52", "18:32", "19:32", "20:32", 
            "21:45", "23:00", "24:32"
        ];
        const weekendSchedule = [
            "08:35", "10:35", "12:35", "14:35", "15:35", "16:35", "18:35", "20:35", 
            "22:35", "24:25"
        ];

        // --- STATE ---
        let liveData = null;
        let lastFetchTime = 0;
        let isUsingLive = false;
        const REFRESH_INTERVAL_MS = 60000; // 60 seconds

        // --- HELPERS ---
        function getScheduleForDate(date) {
            const day = date.getDay();
            const isWeekend = (day === 0 || day === 6);
            return {
                type: isWeekend ? "Weekend Schedule" : "Weekday Schedule",
                times: isWeekend ? weekendSchedule : weekdaySchedule
            };
        }

        function convert12to24(time12h) {
            const [time, modifier] = time12h.split(' ');
            let [hours, minutes] = time.split(':');
            if (hours === '12') hours = '00';
            if (modifier === 'PM' || modifier === 'pm') hours = parseInt(hours, 10) + 12;
            return `${hours}:${minutes}`;
        }

        function formatTime12h(time24) {
            let [hours, minutes] = time24.split(':').map(Number);
            let period = 'AM';
            if (hours >= 24) { hours -= 24; period = 'AM'; }
            else if (hours >= 12) { period = 'PM'; if (hours > 12) hours -= 12; }
            else if (hours === 0) { hours = 12; }
            return `${hours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function getMinutesUntil(targetTime24, targetDate) {
            const now = new Date();
            let [tHours, tMinutes] = targetTime24.split(':').map(Number);
            const target = new Date(targetDate);
            if (tHours >= 24) { tHours -= 24; target.setDate(target.getDate() + 1); }
            target.setHours(tHours, tMinutes, 0, 0);
            return Math.floor((target - now) / 60000);
        }

        // --- LIVE DATA FETCHING ---
        async function fetchLiveTimes() {
            lastFetchTime = Date.now();
            
            // CORRECTED PROXY SYNTAX: Append target URL directly after "?"
            const targetUrl = 'https://metratracker.com/bustime/wireless/html/eta.jsp?route=MD-N&originstop=Chicago+Union+Station&destinationstop=Edgebrook&id=CUS&destinationid=EDGEBROOK&direction=OUTBOUND&showAllBusses=off&t=' + Date.now();
            // Note: We intentionally DO NOT use 'url=' param here, as corsproxy.io standard usage is ?<url>
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const text = await response.text();
                
                const timeRegex = /(\d{1,2}:\d{2}\s+(?:AM|PM))/gi;
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const pageText = doc.body.innerText || "";
                
                const lines = pageText.split('\n');
                const foundTimes = [];
                
                lines.forEach(line => {
                    // Check for destination keywords
                    if (line.includes("To Edgebrook") || line.includes("To Fox Lake") || line.includes("To Healy") || line.includes("To Lake Forest")) { 
                        const match = line.match(timeRegex);
                        if (match) {
                            foundTimes.push(convert12to24(match[0]));
                        }
                    }
                });

                if (foundTimes.length > 0) {
                    liveData = foundTimes;
                    isUsingLive = true;
                } else {
                    if (pageText.includes("No service")) {
                         liveData = [];
                         isUsingLive = true;
                    }
                }
            } catch (error) {
                console.error("Fetch failed, staying on schedule:", error);
            }
        }

        // --- MAIN APP LOOP ---
        async function updateApp() {
            const now = new Date();
            
            // Check fetch (Every 60s)
            if (Date.now() - lastFetchTime > REFRESH_INTERVAL_MS) {
                document.getElementById('data-source-badge').innerHTML = `<div class="loader"></div> Updating...`;
                await fetchLiveTimes();
            }

            // --- UI STATE MANAGEMENT ---
            let timesList = [];
            let sourceLabel = "";
            let scheduleType = "";
            let isTomorrow = false;
            
            const heroIndicator = document.getElementById('hero-status-indicator');
            const liveViewPill = document.getElementById('live-view-pill');
            const footerNoteEl = document.getElementById('footer-note');

            if (isUsingLive && liveData) {
                // --- LIVE MODE ---
                timesList = liveData;
                sourceLabel = `<span class="text-green-400 font-bold"><i class="fa-solid fa-wifi"></i> Live Data</span>`;
                scheduleType = "Live Tracker";
                
                // Show Green Pill in Hero
                heroIndicator.innerHTML = `
                 <div class="flex items-center gap-2 bg-green-900/40 border border-green-500/30 px-3 py-1 rounded-full shadow-[0_0_10px_rgba(74,222,128,0.2)]">
                    <div class="live-dot"></div>
                    <span class="text-[10px] font-bold text-green-400 uppercase tracking-widest">Live Tracker</span>
                 </div>`;
                 
                 // STOP pulsing external button
                 liveViewPill.classList.remove('pulse-ring');
                 liveViewPill.classList.remove('bg-blue-600/20');
                 liveViewPill.classList.add('bg-gray-700/50'); 
                
                 footerNoteEl.innerHTML = `<span class="text-green-500">● Connected to Metra Real-time Tracker</span>`;

                if (timesList.length === 0) {
                     const tomorrow = new Date(now);
                     tomorrow.setDate(tomorrow.getDate() + 1);
                     const nextDaySchedule = getScheduleForDate(tomorrow);
                     timesList = nextDaySchedule.times;
                     sourceLabel = `<span class="text-yellow-500"><i class="fa-solid fa-calendar"></i> Sched (Tomorrow)</span>`;
                     isTomorrow = true;
                     heroIndicator.innerHTML = `
                         <div class="flex items-center gap-2 bg-yellow-900/30 border border-yellow-600/30 px-3 py-1 rounded-full">
                            <i class="fa-solid fa-bed text-[10px] text-yellow-500"></i>
                            <span class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest">No Active Trains</span>
                         </div>`;
                }
            } else {
                // --- SCHEDULE MODE ---
                const currentSchedule = getScheduleForDate(now);
                timesList = currentSchedule.times;
                sourceLabel = `<span class="text-gray-400"><i class="fa-solid fa-calendar"></i> Schedule</span>`;
                scheduleType = currentSchedule.type;
                
                // Show Gray Pill in Hero
                heroIndicator.innerHTML = `
                 <div class="flex items-center gap-2 bg-gray-700/50 border border-gray-600 px-3 py-1 rounded-full">
                    <i class="fa-solid fa-calendar text-[10px] text-gray-400"></i>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Using Schedule</span>
                 </div>`;
                 
                // START pulsing external button
                liveViewPill.classList.add('pulse-ring');
                liveViewPill.classList.add('bg-blue-600/20');
                liveViewPill.classList.remove('bg-gray-700/50');
                
                footerNoteEl.innerHTML = `<span class="text-yellow-600/70">⚠ Unable to connect to live tracker. Showing standard schedule.</span>`;
            }

            // Standardize current time
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeVal = currentHours * 60 + currentMinutes;

            let nextTrain = null;
            let laterTrains = [];
            let scheduleDisplayDate = new Date(now);

            // Filter logic
            if (isTomorrow) {
                scheduleDisplayDate.setDate(scheduleDisplayDate.getDate() + 1);
                nextTrain = timesList[0];
                laterTrains = timesList.slice(1);
            } else {
                for (let time of timesList) {
                    const [h, m] = time.split(':').map(Number);
                    let trainTimeVal = h * 60 + m;
                    if (h >= 24) trainTimeVal = (h - 24) * 60 + m + (24 * 60);

                    if (isUsingLive) {
                         if (!nextTrain) nextTrain = time;
                         else laterTrains.push(time);
                    } else {
                        if (trainTimeVal > currentTimeVal || h >= 24) {
                            if (!nextTrain) nextTrain = time;
                            else laterTrains.push(time);
                        }
                    }
                }

                if (!nextTrain) {
                    isTomorrow = true;
                    scheduleDisplayDate.setDate(scheduleDisplayDate.getDate() + 1);
                    const tomorrowSchedule = getScheduleForDate(scheduleDisplayDate);
                    nextTrain = tomorrowSchedule.times[0];
                    laterTrains = tomorrowSchedule.times.slice(1);
                    
                    if (!isUsingLive) {
                        scheduleType = tomorrowSchedule.type;
                    }
                }
            }

            // Render
            const minutesUntil = getMinutesUntil(nextTrain, scheduleDisplayDate);
            
            // DOM Elements
            const timeRemainingEl = document.getElementById('time-remaining');
            const departureTimeEl = document.getElementById('departure-time');
            const listEl = document.getElementById('schedule-list');
            const statusMsgEl = document.getElementById('status-message');
            const scheduleTypeEl = document.getElementById('schedule-type');
            const badgeEl = document.getElementById('data-source-badge');

            // Update Badge
            badgeEl.innerHTML = sourceLabel;

            // Update Main Display
            if (minutesUntil <= 0 && !isTomorrow) {
                 timeRemainingEl.innerText = "Now";
                 timeRemainingEl.className = "text-5xl font-extrabold tracking-tight text-green-400 drop-shadow-lg";
                 statusMsgEl.innerText = "Train is departing";
            } else {
                if (minutesUntil > 99) {
                    const hours = Math.floor(minutesUntil / 60);
                    const mins = minutesUntil % 60;
                    timeRemainingEl.innerHTML = `${hours}<span class="text-2xl">h</span> ${mins}<span class="text-2xl">m</span>`;
                    timeRemainingEl.className = "text-5xl font-extrabold tracking-tight text-white drop-shadow-lg";
                } else {
                    timeRemainingEl.innerText = minutesUntil;
                    timeRemainingEl.className = "text-6xl font-extrabold tracking-tight text-white drop-shadow-lg";
                }
                statusMsgEl.innerText = isTomorrow ? "First train tomorrow in" : "Departure in";
            }

            departureTimeEl.innerText = formatTime12h(nextTrain);
            scheduleTypeEl.innerText = `${scheduleType} • ${isTomorrow ? 'Tomorrow' : 'Today'}`;

            // Update List
            listEl.innerHTML = '';
            if (laterTrains.length === 0) {
                listEl.innerHTML = `<div class="text-gray-500 text-center py-4 text-sm">No more trains today</div>`;
            } else {
                laterTrains.forEach(time => {
                    if (time.startsWith("24:")) return; 
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-gray-600 transition-colors";
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400">
                                <i class="fa-solid fa-train"></i>
                            </div>
                            <span class="text-lg font-semibold text-gray-200">${formatTime12h(time)}</span>
                        </div>
                        <span class="text-sm text-gray-500 font-medium">MD-N</span>
                    `;
                    listEl.appendChild(el);
                });
            }
        }

        // Initialize
        updateApp();
        // UI ticks every 10s, but fetch only happens every 60s
        setInterval(updateApp, 10000); 
    </script>
</body>
</html>